<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hospital de Ambato - Chat</title>
  </head>
  <body
    style="
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #0b141a;
    "
  >
    <div
      style="
        max-width: 520px;
        margin: 0 auto;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: #111b21;
      "
    >
      <!-- Top bar -->
      <div
        style="
          padding: 12px 14px;
          background: #202c33;
          color: #e9edef;
          display: flex;
          gap: 10px;
          align-items: center;
        "
      >
        <div
          style="
            width: 38px;
            height: 38px;
            border-radius: 999px;
            background: #2a3942;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
          "
        >
          A
        </div>
        <div style="display: flex; flex-direction: column; line-height: 1.1;">
          <div style="font-weight: 700;">Asistente</div>
          <div id="status" style="font-size: 12px; color: #aebac1;">en línea</div>
        </div>
      </div>

      <!-- Chat -->
      <div
        id="chat"
        style="
          flex: 1;
          overflow: auto;
          padding: 14px;
          background: radial-gradient(
              circle at 20% 10%,
              rgba(0, 0, 0, 0.12),
              transparent 35%
            ),
            radial-gradient(
              circle at 80% 30%,
              rgba(0, 0, 0, 0.1),
              transparent 40%
            ),
            #0b141a;
        "
      ></div>

      <!-- Input -->
      <div style="padding: 10px; background: #202c33; display: flex; gap: 10px;">
        <input
          id="msg"
          placeholder="Escribe un mensaje"
          autocomplete="off"
          style="
            flex: 1;
            border: 0;
            border-radius: 999px;
            padding: 12px 14px;
            background: #2a3942;
            color: #e9edef;
            outline: none;
          "
        />
        <button
          id="send"
          style="
            border: 0;
            border-radius: 999px;
            padding: 0 16px;
            background: #00a884;
            color: #062b25;
            font-weight: 800;
            cursor: pointer;
          "
        >
          Enviar
        </button>
      </div>
    </div>

    <script>
      // 1) Pega aquí la URL de tu backend (Cloudflare Worker / Vercel / etc.)
      // Ejemplo: https://hospital-eval.tuusuario.workers.dev
      const BACKEND_BASE_URL = 'https://hospital-eval.jcchachalo.workers.dev'

      const chatEl = document.getElementById('chat')
      const inputEl = document.getElementById('msg')
      const sendBtn = document.getElementById('send')
      const statusEl = document.getElementById('status')

      const STORAGE_KEY = 'demo_wpp_chat_v2_openai_hospital'
      const SCENARIO_KEY = 'demo_wpp_scenario_v1'

      function nowTime() {
        const d = new Date()
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      }

      function bubble({ from, text, time, meta }) {
        const isMe = from === 'me'
        const wrap = document.createElement('div')
        wrap.style.display = 'flex'
        wrap.style.justifyContent = isMe ? 'flex-end' : 'flex-start'
        wrap.style.margin = '6px 0'

        const b = document.createElement('div')
        b.style.maxWidth = '78%'
        b.style.padding = '10px 10px 8px'
        b.style.borderRadius = '14px'
        b.style.background = isMe ? '#005c4b' : '#202c33'
        b.style.color = '#e9edef'
        b.style.boxShadow = '0 1px 0 rgba(0,0,0,.25)'
        b.style.whiteSpace = 'pre-wrap'
        b.style.wordBreak = 'break-word'

        const t = document.createElement('div')
        t.textContent = text

        const foot = document.createElement('div')
        foot.style.display = 'flex'
        foot.style.justifyContent = 'flex-end'
        foot.style.gap = '6px'
        foot.style.marginTop = '4px'
        foot.style.fontSize = '11px'
        foot.style.color = 'rgba(233,237,239,.75)'
        foot.textContent = time || nowTime()

        if (meta) {
          const m = document.createElement('div')
          m.style.fontSize = '12px'
          m.style.color = '#aebac1'
          m.style.margin = '8px 0 2px'
          m.style.textAlign = 'center'
          m.textContent = meta
          chatEl.appendChild(m)
        }

        b.appendChild(t)
        b.appendChild(foot)
        wrap.appendChild(b)
        chatEl.appendChild(wrap)
        chatEl.scrollTop = chatEl.scrollHeight
      }

      function loadMessages() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')
        } catch {
          return []
        }
      }

      function saveMessages(messages) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(messages))
      }

      function loadScenario() {
        try {
          return localStorage.getItem(SCENARIO_KEY) || ''
        } catch {
          return ''
        }
      }

      function saveScenario(scenario) {
        localStorage.setItem(SCENARIO_KEY, scenario || '')
      }

      function renderAll(messages) {
        chatEl.innerHTML = ''
        for (const m of messages) bubble(m)
      }

      function setTyping(on) {
        statusEl.textContent = on ? 'escribiendo…' : 'en línea'
      }

      function setInputEnabled(enabled) {
        inputEl.disabled = !enabled
        sendBtn.disabled = !enabled
        sendBtn.style.opacity = enabled ? '1' : '0.6'
      }

      async function apiPost(path, payload) {
        const res = await fetch(`${BACKEND_BASE_URL}${path}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: payload ? JSON.stringify(payload) : '{}',
        })
        if (!res.ok) {
          const t = await res.text().catch(() => '')
          throw new Error(`HTTP ${res.status} - ${t}`)
        }
        return await res.json()
      }

      async function ensureScenarioAndIntro(messages) {
        // Si ya hay conversación, no la reiniciamos.
        if (messages.length) return messages

        messages.push({
          from: 'bot',
          text: 'Hola. Vamos a simular una conversación estilo WhatsApp.',
          time: nowTime(),
        })
        messages.push({
          from: 'bot',
          text:
            'Te mostraré una situación dentro de un hospital (tipo chisme/rumor). Responde como lo harías tú y luego te calificaré (1 a 100) por tacto, calidez y elementos comunicativos.',
          time: nowTime(),
        })
        saveMessages(messages)
        renderAll(messages)

        let scenario = loadScenario()
        if (!scenario) {
          setTyping(true)
          setInputEnabled(false)
          try {
            const data = await apiPost('/api/scenario')
            scenario = data?.scenario || ''
            saveScenario(scenario)
          } catch (e) {
            scenario =
              'No pude generar la situación (backend/CORS). Aun así, imagina que un compañero te cuenta un rumor delicado sobre una relación entre dos personas del hospital. ¿Cómo responderías con tacto?'
            console.error(e)
          } finally {
            setTyping(false)
            setInputEnabled(true)
          }
        }

        messages.push({
          from: 'bot',
          text: scenario || '(Sin situación)',
          time: nowTime(),
        })
        messages.push({
          from: 'bot',
          text: '¿Qué responderías?',
          time: nowTime(),
        })
        saveMessages(messages)
        renderAll(messages)
        return messages
      }

      function hasEvaluationAlready(messages) {
        return messages.some((m) => m?.meta === 'evaluación')
      }

      function formatEvaluation(e) {
        const score = e?.score ?? '—'
        const tacto = e?.breakdown?.tacto ?? '—'
        const calidez = e?.breakdown?.calidez ?? '—'
        const elementos = e?.breakdown?.elementos ?? '—'
        const feedback = e?.feedback ?? ''

        return (
          `Puntaje: ${score}/100\n` +
          `Tacto: ${tacto}\n` +
          `Calidez: ${calidez}\n` +
          `Elementos comunicativos: ${elementos}\n\n` +
          `Feedback:\n${feedback}`
        )
      }

      async function send() {
        const text = inputEl.value
        if (!text.trim()) return
        const myText = text.trim()

        const myMsg = { from: 'me', text: myText, time: nowTime() }
        messages.push(myMsg)
        saveMessages(messages)
        bubble(myMsg)
        inputEl.value = ''
        inputEl.focus()

        // Evaluamos SOLO la primera respuesta del usuario por sesión (puedes cambiarlo).
        if (hasEvaluationAlready(messages)) {
          setTyping(true)
          setTimeout(() => {
            const botMsg = {
              from: 'bot',
              text:
                'Ya tengo una evaluación. Si quieres reiniciar y generar otra situación, recarga la página y borra el almacenamiento del navegador (LocalStorage).',
              time: nowTime(),
            }
            messages.push(botMsg)
            saveMessages(messages)
            bubble(botMsg)
            setTyping(false)
          }, 650)
          return
        }

        const scenario = loadScenario()
        setTyping(true)
        setInputEnabled(false)

        try {
          const data = await apiPost('/api/evaluate', {
            scenario,
            userResponse: myText,
          })

          // Mensaje de resultado como "meta" centrado + burbuja
          bubble({ meta: 'evaluación' })
          const botMsg = {
            from: 'bot',
            text: formatEvaluation(data),
            time: nowTime(),
            meta: 'evaluación',
          }
          messages.push(botMsg)
          saveMessages(messages)
          bubble(botMsg)
        } catch (e) {
          console.error(e)
          const botMsg = {
            from: 'bot',
            text:
              'No pude evaluar tu respuesta (backend/CORS). Revisa la URL del backend y que CORS permita tu GitHub Pages.',
            time: nowTime(),
          }
          messages.push(botMsg)
          saveMessages(messages)
          bubble(botMsg)
        } finally {
          setTyping(false)
          setInputEnabled(true)
        }
      }

      // Init
      let messages = loadMessages()
      renderAll(messages)

      ensureScenarioAndIntro(messages).catch(console.error)

      sendBtn.addEventListener('click', send)
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') send()
      })
    </script>
  </body>
</html>